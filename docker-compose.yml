services:
  front:
    container_name: front
    networks:
      - transcendence
    build:
      context: apps/frontend
      dockerfile: ../../infra/docker/front/Dockerfile
    env_file: .env
    volumes:
      - ./apps/frontend:/front
      - /front/node_modules
    restart: unless-stopped
    expose:
      - "5173"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5173"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  database:
    container_name: database
    networks:
      - transcendence
    build:
      context: apps/database
      dockerfile: ../../infra/docker/database/Dockerfile
    env_file: .env
    volumes:
      - ./apps/database:/database
      - /database/node_modules
      - db_data:/database/data
    restart: unless-stopped
    expose:
      - "3020"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3020/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  chatback:
    container_name: chatback
    networks:
      - transcendence
    build:
      context: apps/chatback
      dockerfile: ../../infra/docker/chatback/Dockerfile
    env_file: .env
    volumes:
      - ./apps/chatback:/chatback
      - /chatback/node_modules
    restart: unless-stopped
    expose:
      - "3000"
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  gameback:
    container_name: gameback
    networks:
      - transcendence
    build:
      context: apps/gameback
      dockerfile: ../../infra/docker/gameback/Dockerfile
    env_file: .env
    volumes:
      - ./apps/gameback:/gameback
      - /gameback/node_modules
    restart: unless-stopped
    expose:
      - "3010"
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3010"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  quickplayback:
    container_name: quickplayback
    networks:
      - transcendence
    build:
      context: apps/quickplayback
      dockerfile: ../../infra/docker/quickplayback/Dockerfile
    env_file: .env
    volumes:
      - ./apps/quickplayback:/quickplay
      - /quickplayback/node_modules
    restart: unless-stopped
    expose:
      - "3030"
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3030"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  tournamentback:
    container_name: tournamentback
    networks:
      - transcendence
    build:
      context: apps/tournamentback
      dockerfile: ../../infra/docker/tournamentback/Dockerfile
    env_file: .env
    volumes:
      - ./apps/tournamentback:/tournament
      - /tournamentback/node_modules
    restart: unless-stopped
    expose:
      - "3040"
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3040/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
  
  authback:
    container_name: authback
    networks:
      - transcendence
    build:
      context: apps/authback
      dockerfile: ../../infra/docker/authback/Dockerfile
    env_file: .env
    volumes:
      - ./apps/authback:/authback
      - /authback/node_modules
    restart: unless-stopped
    expose:
      - "3050"
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3050/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  nginx:
    container_name: nginx
    networks:
      - transcendence
    build:
      context: infra/docker/nginx
      dockerfile: Dockerfile
    ports:
      - "8443:443"
    depends_on:
      front:
        condition: service_healthy
      database:
        condition: service_healthy
      chatback:
        condition: service_healthy
      gameback:
        condition: service_healthy
      quickplayback:
        condition: service_healthy
      tournamentback:
        condition: service_healthy
      authback:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "https://localhost:443", "--no-check-certificate"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

networks:
  transcendence:
    driver: bridge

volumes:
  db_data:
    driver: local
