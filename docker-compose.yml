services:
  front:
    container_name: front
    networks:
      - transcendence
    build:
      context: apps/frontend
      dockerfile: ../../infra/docker/front/Dockerfile
    env_file: .env
    volumes:
      - ./apps/frontend:/front
      - /front/node_modules
    restart: unless-stopped
    expose:
      - "5173"

  database:
    container_name: database
    networks:
      - transcendence
    build:
      context: apps/database
      dockerfile: ../../infra/docker/database/Dockerfile
    env_file: .env
    volumes:
      - ./apps/database:/database
      - /database/node_modules
      - db_data:/database/data
    restart: unless-stopped
    expose:
      - "3020"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3020/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  chatback:
    container_name: chatback
    networks:
      - transcendence
    build:
      context: apps/chatback
      dockerfile: ../../infra/docker/chatback/Dockerfile
    env_file: .env
    volumes:
      - ./apps/chatback:/chatback
      - /chatback/node_modules
    restart: unless-stopped
    expose:
      - "3000"
    depends_on:
      database:
        condition: service_healthy

  gameback:
    container_name: gameback
    networks:
      - transcendence
    build:
      context: apps/gameback
      dockerfile: ../../infra/docker/gameback/Dockerfile
    env_file: .env
    volumes:
      - ./apps/gameback:/gameback
      - /gameback/node_modules
    restart: unless-stopped
    expose:
      - "3010"
    depends_on:
      database:
        condition: service_healthy

  quickplayback:
    container_name: quickplayback
    networks:
      - transcendence
    build:
      context: apps/quickplayback
      dockerfile: ../../infra/docker/quickplayback/Dockerfile
    env_file: .env
    volumes:
      - ./apps/quickplayback:/quickplayback
      - /quickplayback/node_modules
    restart: unless-stopped
    expose:
      - "3030"
    depends_on:
      database:
        condition: service_healthy

  nginx:
    container_name: nginx
    networks:
      - transcendence
    build:
      context: infra/docker/nginx
      dockerfile: Dockerfile
    ports:
      - "8443:443"
    depends_on:
      - front
      - database
      - chatback
      - gameback
    restart: unless-stopped

networks:
  transcendence:
    driver: bridge

volumes:
  db_data:
    driver: local
