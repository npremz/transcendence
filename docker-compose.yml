# Définition des templates réutilisables
x-healthcheck-wget: &healthcheck-wget
  interval: 10s
  timeout: 5s
  retries: 3
  start_period: 20s

services:
  front:
    container_name: front
    networks:
      - transcendence
    build:
      context: apps/frontend
      dockerfile: ../../infra/docker/front/Dockerfile
    env_file: .env
    volumes:
      - ./apps/frontend:/front
      - front_node_modules:/front/node_modules
    restart: unless-stopped
    expose:
      - "5173"
    environment:
      - PORT=5173
    healthcheck:
      <<: *healthcheck-wget
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5173"]
      start_period: 30s

  database:
    container_name: database
    networks:
      - transcendence
    build:
      context: apps/database
      dockerfile: ../../infra/docker/database/Dockerfile
    env_file: .env
    volumes:
      - ./apps/database:/database
      - database_node_modules:/database/node_modules
      - db_data:/database/data
    restart: unless-stopped
    expose:
      - "3020"
    environment:
      - PORT=3020
    healthcheck:
      <<: *healthcheck-wget
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3020/health"]
      retries: 5
      start_period: 40s

  chatback:
    container_name: chatback
    networks:
      - transcendence
    build:
      context: apps/chatback
      dockerfile: ../../infra/docker/chatback/Dockerfile
    env_file: .env
    volumes:
      - ./apps/chatback:/chatback
      - chatback_node_modules:/chatback/node_modules
    restart: unless-stopped
    expose:
      - "3000"
    environment:
      - PORT=3000
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      <<: *healthcheck-wget
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]

  userback:
    container_name: userback
    networks:
      - transcendence
    build:
      context: apps/userback
      dockerfile: ../../infra/docker/userback/Dockerfile
    env_file: .env
    volumes:
      - ./apps/userback:/userback
      - userback_node_modules:/userback/node_modules
    restart: unless-stopped
    expose:
      - "3060"
    environment:
      - PORT=3060
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      <<: *healthcheck-wget
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3060"]

  gameback:
    container_name: gameback
    networks:
      - transcendence
    build:
      context: apps/gameback
      dockerfile: ../../infra/docker/gameback/Dockerfile
    env_file: .env
    volumes:
      - ./apps/gameback:/gameback
      - gameback_node_modules:/gameback/node_modules
    restart: unless-stopped
    expose:
      - "3010"
    environment:
      - PORT=3010
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      <<: *healthcheck-wget
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3010"]

  quickplayback:
    container_name: quickplayback
    networks:
      - transcendence
    build:
      context: apps/quickplayback
      dockerfile: ../../infra/docker/quickplayback/Dockerfile
    env_file: .env
    volumes:
      - ./apps/quickplayback:/quickplay
      - quickplayback_node_modules:/quickplay/node_modules
    restart: unless-stopped
    expose:
      - "3030"
    environment:
      - PORT=3030
      - BACKEND_HOST=nginx:443
      - GAMEBACK_HOST=gameback:3010
    depends_on:
      database:
        condition: service_healthy
      gameback:
        condition: service_healthy
    healthcheck:
      <<: *healthcheck-wget
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3030"]

  tournamentback:
    container_name: tournamentback
    networks:
      - transcendence
    build:
      context: apps/tournamentback
      dockerfile: ../../infra/docker/tournamentback/Dockerfile
    env_file: .env
    volumes:
      - ./apps/tournamentback:/tournament
      - tournamentback_node_modules:/tournament/node_modules
    restart: unless-stopped
    expose:
      - "3040"
    environment:
      - PORT=3040
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      <<: *healthcheck-wget
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3040/health"]

  blockchainback:
    container_name: blockchainback
    networks:
      - transcendence
    build:
      context: apps/blockchainback
      dockerfile: ../../infra/docker/blockchainback/Dockerfile
    env_file: .env
    volumes:
      - ./apps/blockchainback:/blockchainback
      - blockchainback_node_modules:/blockchainback/node_modules
      - ./blockchain/build:/blockchain/build:ro
    restart: unless-stopped
    expose:
      - "3070"
    environment:
      - PORT=3070
    healthcheck:
      <<: *healthcheck-wget
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3070/health"]

  nginx:
    container_name: nginx
    networks:
      - transcendence
    build:
      context: infra/docker/nginx
      dockerfile: Dockerfile
    ports:
      - "8443:443"
      - "8080:80"
    depends_on:
      front:
        condition: service_healthy
      database:
        condition: service_healthy
      chatback:
        condition: service_healthy
      gameback:
        condition: service_healthy
      game3dback:
        condition: service_healthy
      quickplayback:
        condition: service_healthy
      tournamentback:
        condition: service_healthy
      blockchainback:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      <<: *healthcheck-wget
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "https://127.0.0.1:443", "--no-check-certificate"]
      start_period: 30s

networks:
  transcendence:
    driver: bridge

volumes:
  front_node_modules:
  chatback_node_modules:
  userback_node_modules:
  gameback_node_modules:
  game3dback_node_modules:
  quickplayback_node_modules:
  tournamentback_node_modules:
  blockchainback_node_modules:
  database_node_modules:
  db_data:
